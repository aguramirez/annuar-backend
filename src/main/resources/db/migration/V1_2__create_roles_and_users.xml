<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd">

    <changeSet id="1.2.0" author="developer">
        <!-- Insertar usuario administrador inicial -->
        <insert tableName="users">
            <column name="id" valueComputed="uuid_generate_v4()"/>
            <column name="email" value="admin@cinetickets.com"/>
            <column name="password_hash" value="$2a$10$yX5CY4xECiy5S4H7iwdRB.9gMVZ6HUWvFzN2jvQJWltF1JpVOe53S"/> <!-- contraseña: admin123 -->
            <column name="first_name" value="Admin"/>
            <column name="last_name" value="System"/>
            <column name="role" value="ADMIN"/>
            <column name="status" value="ACTIVE"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
    </changeSet>
    
    <changeSet id="1.2.1" author="developer">
        <!-- Crear tablas para manejo de reservas y tickets -->
        <createTable tableName="ticket_types">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cinema_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_ticket_types_cinema" references="cinemas(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="price" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="reservations">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints foreignKeyName="fk_reservations_user" references="users(id)"/>
            </column>
            <column name="show_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_reservations_show" references="shows(id)" deleteCascade="true"/>
            </column>
            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(20)" defaultValue="PENDING"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="reserved_seats">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="reservation_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_reserved_seats_reservation" references="reservations(id)" deleteCascade="true"/>
            </column>
            <column name="seat_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_reserved_seats_seat" references="seats(id)" deleteCascade="true"/>
            </column>
            <column name="ticket_type_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_reserved_seats_ticket_type" references="ticket_types(id)"/>
            </column>
            <column name="price" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="reserved_seats" columnNames="reservation_id, seat_id" constraintName="uk_reserved_seats"/>
    </changeSet>
    
    <changeSet id="1.2.2" author="developer">
        <!-- Crear tablas para productos y combos -->
        <createTable tableName="product_categories">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cinema_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_product_categories_cinema" references="cinemas(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="image_url" type="varchar(255)"/>
            <column name="display_order" type="integer" defaultValue="0"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="products">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="category_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_products_category" references="product_categories(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="price" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="image_url" type="varchar(255)"/>
            <column name="stock" type="integer"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="combos">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cinema_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_combos_cinema" references="cinemas(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="price" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="image_url" type="varchar(255)"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="combo_items">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="combo_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_combo_items_combo" references="combos(id)" deleteCascade="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_combo_items_product" references="products(id)" deleteCascade="true"/>
            </column>
            <column name="quantity" type="integer" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="1.2.3" author="developer">
        <!-- Crear tablas para órdenes y pagos -->
        <createTable tableName="orders">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="uuid">
                <constraints foreignKeyName="fk_orders_user" references="users(id)"/>
            </column>
            <column name="reservation_id" type="uuid">
                <constraints foreignKeyName="fk_orders_reservation" references="reservations(id)"/>
            </column>
            <column name="operator_id" type="uuid">
                <constraints foreignKeyName="fk_orders_operator" references="users(id)"/>
            </column>
            <column name="subtotal" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="discount" type="decimal(10, 2)" defaultValue="0"/>
            <column name="tax" type="decimal(10, 2)" defaultValue="0"/>
            <column name="total" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_method" type="varchar(50)"/>
            <column name="payment_status" type="varchar(20)" defaultValue="PENDING"/>
            <column name="payment_reference" type="varchar(255)"/>
            <column name="qr_code" type="varchar(255)"/>
            <column name="order_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="text"/>
            <column name="status" type="varchar(20)" defaultValue="PENDING"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="order_items">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_order_items_order" references="orders(id)" deleteCascade="true"/>
            </column>
            <column name="item_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="integer" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="subtotal" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <createTable tableName="promotions">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cinema_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_promotions_cinema" references="cinemas(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="discount_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="discount_value" type="decimal(10, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(50)">
                <constraints unique="true"/>
            </column>
            <column name="start_date" type="timestamp with time zone"/>
            <column name="end_date" type="timestamp with time zone"/>
            <column name="usage_limit" type="integer"/>
            <column name="usage_count" type="integer" defaultValue="0"/>
            <column name="is_active" type="boolean" defaultValueBoolean="true"/>
            <column name="applies_to" type="varchar(50)"/>
            <column name="min_purchase" type="decimal(10, 2)" defaultValue="0"/>
            <column name="created_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp with time zone" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>